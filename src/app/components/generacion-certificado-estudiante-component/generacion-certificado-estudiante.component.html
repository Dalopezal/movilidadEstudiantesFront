<app-sidebar></app-sidebar>
<div class="container fuente" style="padding-top: 30px;">
  <div class="row h-100">
    <main class="col-12 d-flex flex-column">
      <div class="row flex-grow-1">

        <!-- Columna izquierda: filtros + tabla -->
        <section class="col-12 col-xl-12 d-flex flex-column" style="height: 75vh; font-size: 14px;">
          <div class="card shadow-sm d-flex flex-column flex-grow-1">

            <!-- Título -->
            <div class="card-header d-flex align-items-center" style="background:#E2E6F7;">
              <p class="mb-0" style="color:#0D133F;font-weight:bold;">
                {{ 'CERTIFICADO_ESTUDIANTES.TITULO' | translate }}
              </p>
            </div>

            <!-- Fila de combos -->
            <div class="card-header d-flex flex-wrap align-items-center gap-3" style="background:white;">

              <!-- Selección Estrategia -->
              <select class="form-select" style="font-size:13px; max-width:200px;"
                      [(ngModel)]="estrategiaId">
                <option [ngValue]="null">{{ 'CERTIFICADO_ESTUDIANTES.SELECCION_ESTRATEGIA' | translate }}</option>
                <option *ngFor="let e of listaEstrategias" [ngValue]="e.estrategiaId">
                  {{ e.estrategiaNombre }}
                </option>
              </select>

              <!-- Planeación -->
              <select class="form-select" style="font-size:13px; max-width:220px;"
                      [(ngModel)]="planeacionId">
                <option [ngValue]="null">{{ 'CERTIFICADO_ESTUDIANTES.PLANEACION' | translate }}</option>
                <option *ngFor="let p of listaPlaneaciones" [ngValue]="p.id">
                  {{ p.titulo }}
                </option>
              </select>

              <!-- Programa -->
              <select class="form-select" style="font-size:13px; max-width:180px;"
                      [(ngModel)]="programaCodigo"
                      (change)="onProgramaChange()">
                <option [ngValue]="null">{{ 'CERTIFICADO_ESTUDIANTES.PROGRAMA' | translate }}</option>
                <option *ngFor="let prog of listaProgramas" [ngValue]="prog.codigo">
                  {{ prog.nombre }}
                </option>
              </select>

              <!-- Componente -->
              <select class="form-select" style="font-size:13px; max-width:180px;"
                      [(ngModel)]="componenteCodigo"
                      (change)="onComponenteChange()">
                <option [ngValue]="null">{{ 'CERTIFICADO_ESTUDIANTES.COMPONENTE' | translate }}</option>
                <option *ngFor="let comp of listaComponentes" [ngValue]="comp.codigo">
                  {{ comp.nombre }}
                </option>
              </select>

              <!-- Grupo -->
              <select class="form-select" style="font-size:13px; max-width:120px;"
                      [(ngModel)]="grupoId">
                <option [ngValue]="null">{{ 'CERTIFICADO_ESTUDIANTES.GRUPO' | translate }}</option>
                <option *ngFor="let grupo of listaGrupos" [ngValue]="grupo">
                  {{ grupo }}
                </option>
              </select>

              <!-- Buscar Estudiantes -->
              <button class="btn btn-primary d-flex align-items-center gap-2"
                      style="background:#0D133F;border-color:#0D133F;font-size:13px;padding:5px 10px;white-space:nowrap;"
                      (click)="buscarEstudiantes()"
                      [disabled]="loading">
                <i class="fas fa-search"></i> {{ 'CERTIFICADO_ESTUDIANTES.BUSCAR_ESTUDIANTES' | translate }}
              </button>
            </div>

            <!-- Fila búsqueda por cédula -->
            <div class="card-header d-flex flex-wrap align-items-center gap-3" style="background:white;">
              <button class="btn btn-primary d-flex align-items-center gap-2"
                      style="background:#0D133F;border-color:#0D133F;font-size:13px;padding:5px 10px;"
                      (click)="buscarEstudiantes()">
                <i class="fas fa-sync-alt"></i> {{ 'CERTIFICADO_ESTUDIANTES.ACTUALIZAR' | translate }}
              </button>

              <div class="d-flex align-items-center gap-2">
                <input type="text"
                       class="form-control"
                       [placeholder]="'CERTIFICADO_ESTUDIANTES.CEDULA' | translate"
                       [(ngModel)]="filtroCedula"
                       name="filtroCedula"
                       style="border-radius:22px;background:#f2f0f0;font-size:13px;width:220px;">
                <button class="btn btn-primary d-flex align-items-center gap-2"
                        style="background:#0D133F;border-color:#0D133F;font-size:13px;padding:5px 10px;"
                        (click)="buscarPorCedula()">
                  <i class="fas fa-search"></i> {{ 'CERTIFICADO_ESTUDIANTES.BUSCAR' | translate }}
                </button>
              </div>

              <button class="btn btn-secondary d-flex align-items-center gap-2"
                      style="background:#4b5563;border-color:#4b5563;font-size:13px;padding:5px 15px;"
                      [disabled]="!estudianteSeleccionado"
                      data-bs-toggle="modal"
                      data-bs-target="#modalCertificado"
                      (click)="onAbrirModalVista()">
                <i class="fas fa-eye"></i> {{ 'CERTIFICADO_ESTUDIANTES.VISTA_PREVIA' | translate }}
              </button>

              <button class="btn btn-primary"
                      style="background:#0D133F;border-color:#0D133F;font-size:13px;padding:5px 15px;margin-left:auto;"
                      (click)="generarCertificados()"
                      [disabled]="!estudianteSeleccionado">
                <i class="fas fa-file-pdf"></i> {{ 'CERTIFICADO_ESTUDIANTES.GENERAR_CERTIFICADO' | translate }}
              </button>
            </div>

            <!-- Tabla -->
            <div class="table-responsive table-wrapper flex-grow-1">
              <table class="table table-striped mb-0">
                <thead class="table-primary" style="font-size:13px;">
                  <tr align="left">
                    <th style="background:white;color:#0D133F;">{{ 'CERTIFICADO_ESTUDIANTES.CEDULA' | translate }}</th>
                    <th style="background:white;color:#0D133F;">{{ 'CERTIFICADO_ESTUDIANTES.NOMBRE' | translate }}</th>
                    <th style="background:white;color:#0D133F;">
                      {{ 'CERTIFICADO_ESTUDIANTES.GENERAR_EN_TABLA' | translate }}
                    </th>
                  </tr>
                </thead>
                <tbody style="font-size:13px;">
                  <tr *ngIf="loading">
                    <td colspan="3" class="text-center">
                      <i class="fas fa-spinner fa-spin fa-3x"></i>
                      <p style="margin:0;">{{ 'CERTIFICADO_ESTUDIANTES.CARGANDO_DATOS' | translate }}</p>
                    </td>
                  </tr>

                  <tr *ngFor="let item of pagedData; trackBy: trackByIndex">
                    <td align="center">{{ item.cedula }}</td>
                    <td>{{ item.nombre }}</td>
                    <td align="center">
                      <div class="form-check d-flex justify-content-center">
                        <input type="checkbox"
                               class="form-check-input large-checkbox"
                               [(ngModel)]="item.seleccionado"
                               (change)="onSeleccionarEstudiante(item)"
                               style="cursor:pointer;">
                      </div>
                    </td>
                  </tr>

                  <tr *ngIf="!loading && pagedData.length === 0">
                    <td colspan="3" class="text-center">{{ 'CERTIFICADO_ESTUDIANTES.NO_HAY_REGISTROS' | translate }}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Paginación -->
            <div class="card-footer d-flex justify-content-between align-items-center flex-wrap">
              <div class="items-per-page d-flex align-items-center gap-2">
                <label for="itemsPerPageSelect" class="mb-0">{{ 'CERTIFICADO_ESTUDIANTES.MOSTRAR' | translate }}</label>
                <select id="itemsPerPageSelect"
                        (change)="onPageSizeChange($event)"
                        [value]="pageSize">
                  <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
                </select>
                <span>{{ 'CERTIFICADO_ESTUDIANTES.DE' | translate }} {{ data.length }}</span>
              </div>

              <nav>
                <ul class="pagination mb-0">
                  <li class="page-item" [class.disabled]="currentPage === 1">
                    <button class="page-link text-white"
                            (click)="goToPage(currentPage - 1)"
                            style="background:#0D133F">
                      &laquo;
                    </button>
                  </li>
                  <li class="page-item"
                      *ngFor="let p of pages"
                      [class.active]="p === currentPage">
                    <button class="page-link" (click)="goToPage(p)">{{ p }}</button>
                  </li>
                  <li class="page-item" [class.disabled]="currentPage === totalPages">
                    <button class="page-link text-white"
                            (click)="goToPage(currentPage + 1)"
                            style="background:#0D133F">
                      &raquo;
                    </button>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>
</div>

<!-- ============================================
     MODAL VISTA PREVIA CERTIFICADO CON CANVAS
     ============================================ -->
<div class="modal fade" id="modalCertificado" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">

      <div class="modal-header" style="border-bottom:1px solid #e5e7eb;background:#E2E6F7;">
        <h5 class="modal-title" style="color:#0D133F;font-weight:bold;">{{ 'CERTIFICADO_ESTUDIANTES.VISTA_PREVIA_CERTIFICADO' | translate }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" [attr.aria-label]="'CERTIFICADO_ESTUDIANTES.CERRAR' | translate"></button>
      </div>

      <div class="modal-body d-flex justify-content-center align-items-center p-4"
           style="background:#f5f5f5;">

        <!-- CANVAS CERTIFICADO -->
        <div *ngIf="estudianteSeleccionado" style="max-width:100%; overflow:auto;">
          <canvas id="certCanvas" style="max-width:100%; height:auto; box-shadow:0 10px 40px rgba(0,0,0,0.2);"></canvas>
        </div>

        <!-- Placeholder cuando no hay estudiante -->
        <div *ngIf="!estudianteSeleccionado" class="text-center text-muted">
          <i class="fas fa-file-certificate fa-3x mb-3"></i>
          <p>{{ 'CERTIFICADO_ESTUDIANTES.NO_HAY_ESTUDIANTE_SELECCIONADO' | translate }}</p>
        </div>

      </div>
    </div>
  </div>
</div>

<ngx-sonner-toaster />
<p-confirmDialog appendTo="body"></p-confirmDialog>
