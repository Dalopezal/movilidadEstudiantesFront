<app-sidebar></app-sidebar>

<div class="container fuente" style="padding-top: 30px;">
  <div class="row">
    <main class="col-12 d-flex flex-column">
      <div class="card shadow-sm flex-grow-1">

        <!-- Header -->
        <div class="card-header d-flex align-items-center" style="background: #E2E6F7;">
          <button
            [title]="'SOLICITUD_CONVENIO.BTN_VOLVER' | translate"
            mat-icon-button
            (click)="goBack()"
            [disableRipple]="true"
            class="me-2"
            style="background-color: transparent; width: 40px; height: 40px; padding: 0;">
            <mat-icon style="font-size: 14px; width: 14px; height: 14px;">arrow_back</mat-icon>
          </button>
          <p class="mb-0 fw-bold" style="color: #0D133F; font-size: 14px;">
            {{ 'SOLICITUD_CONVENIO.TITULO' | translate }}
          </p>
        </div>

        <!-- Tabs de tipo solicitud -->
        <div class="tipo-solicitud-container" style="padding: 20px 24px 16px 24px; border-bottom: 2px solid #e5e7eb;">
          <div class="tipo-solicitud-tabs">
            <button
              type="button"
              class="tab-btn"
              [class.active]="tipoSolicitud === 'Apertura'"
              (click)="cambiarTipo('Apertura')">
              <i class="fas fa-file-signature"></i> {{ 'SOLICITUD_CONVENIO.TABS.APERTURA' | translate }}
            </button>
            <button
              type="button"
              class="tab-btn"
              [class.active]="tipoSolicitud === 'Renovacion'"
              (click)="cambiarTipo('Renovacion')">
              <i class="fas fa-sync-alt"></i> {{ 'SOLICITUD_CONVENIO.TABS.RENOVACION' | translate }}
            </button>
            <button
              type="button"
              class="tab-btn"
              [class.active]="tipoSolicitud === 'MisSolicitudes'"
              (click)="cambiarTipo('MisSolicitudes')">
              <i class="fas fa-list-alt"></i> {{ 'SOLICITUD_CONVENIO.TABS.MIS_SOLICITUDES' | translate }}
            </button>
          </div>
        </div>

        <!-- Body -->
        <div class="card-body d-flex" style="background: white; min-height: 70vh;">

          <!-- ============================================= -->
          <!-- CONTENIDO APERTURA -->
          <!-- ============================================= -->
          <div *ngIf="tipoSolicitud === 'Apertura'" class="d-flex w-100">

            <!-- Sidebar de pasos -->
            <div class="sidebar-pasos">
              <div
                *ngFor="let paso of pasos; let i = index"
                class="paso-item"
                [class.active]="i === pasoActual"
                [class.completed]="i < pasoActual"
                (click)="irAPaso(i)"
                style="cursor:pointer;">
                <span class="paso-numero">{{ i + 1 }}</span>
                {{ paso.titulo }}
              </div>
            </div>

            <!-- Contenido del formulario -->
            <div class="content-area">

              <form #form="ngForm" (ngSubmit)="guardar(form)" class="flex-grow-1">

                <!-- ============================================= -->
                <!-- PASO 1: INSTITUCIÓN -->
                <!-- ============================================= -->
                <div *ngIf="pasoActual === 0" class="form-container">
                  <h2 class="form-title">{{ 'SOLICITUD_CONVENIO.PASO1.TITULO' | translate }}</h2>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">{{ 'SOLICITUD_CONVENIO.PASO1.DESCRIPCION' | translate }}</label>
                      <input
                        type="text"
                        class="form-control"
                        [(ngModel)]="formData.descripcion"
                        name="descripcion"
                        [placeholder]="'SOLICITUD_CONVENIO.PASO1.DESCRIPCION_PLACEHOLDER' | translate"
                        required>
                    </div>
                    <div class="form-group">
                      <label class="form-label">{{ 'SOLICITUD_CONVENIO.PASO1.INSTITUCION' | translate }}</label>
                      <select
                        class="form-control"
                        [(ngModel)]="selectedInstitucion"
                        name="institucion"
                        (change)="onInstitucionChange()">
                        <option value="">{{ 'SOLICITUD_CONVENIO.PASO1.SELECCIONE_INSTITUCION' | translate }}</option>
                        <option *ngFor="let i of institucionesFiltradas" [value]="i.id">
                          {{ i.nombre }}
                        </option>
                        <option value="nueva">{{ 'SOLICITUD_CONVENIO.PASO1.OTRA_INSTITUCION' | translate }}</option>
                      </select>
                    </div>
                  </div>

                  <!-- Campos para nueva institución -->
                  <div *ngIf="selectedInstitucion === 'nueva'">
                    <h3 class="form-subtitle">{{ 'SOLICITUD_CONVENIO.PASO1.NUEVA_INSTITUCION' | translate }}</h3>

                    <div class="form-row">
                      <div class="form-group">
                        <label class="form-label">{{ 'SOLICITUD_CONVENIO.PASO1.PAIS' | translate }}</label>
                        <select
                          class="form-control"
                          [(ngModel)]="selectedPais"
                          name="pais"
                          (change)="onPaisChange()">
                          <option value="">{{ 'SOLICITUD_CONVENIO.PASO1.SELECCIONE_PAIS' | translate }}</option>
                          <option *ngFor="let p of paises" [value]="p.id">{{ p.nombre }}</option>
                        </select>
                      </div>

                      <div class="form-group">
                        <label class="form-label">{{ 'SOLICITUD_CONVENIO.PASO1.CIUDAD' | translate }}</label>
                        <select
                          class="form-control"
                          [(ngModel)]="selectedCiudad"
                          name="ciudad"
                          (change)="onCiudadChange()"
                          [disabled]="!ciudades || ciudades.length === 0">
                          <option value="">{{ 'SOLICITUD_CONVENIO.PASO1.SELECCIONE_CIUDAD' | translate }}</option>
                          <option *ngFor="let c of ciudades" [ngValue]="c.id">{{ c.nombre }}</option>
                        </select>
                      </div>
                    </div>

                    <div class="form-group">
                      <label class="form-label">{{ 'SOLICITUD_CONVENIO.PASO1.NOMBRE_INSTITUCION' | translate }}</label>
                      <input
                        type="text"
                        class="form-control"
                        [(ngModel)]="formData.institucion"
                        name="institucion"
                        [placeholder]="'SOLICITUD_CONVENIO.PASO1.NOMBRE_PLACEHOLDER' | translate"
                        required>
                    </div>
                  </div>
                </div>

                <!-- ============================================= -->
                <!-- PASO 2: ANTECEDENTES Y OBJETIVOS -->
                <!-- ============================================= -->
                <div *ngIf="pasoActual === 1" class="form-container">
                  <h2 class="form-title">{{ 'SOLICITUD_CONVENIO.PASO2.TITULO' | translate }}</h2>

                  <div class="form-group">
                    <label class="form-label">{{ 'SOLICITUD_CONVENIO.PASO2.ANTECEDENTES' | translate }}</label>
                    <textarea
                      class="form-control"
                      [(ngModel)]="formData.antecedentes"
                      name="antecedentes"
                      [placeholder]="'SOLICITUD_CONVENIO.PASO2.ANTECEDENTES_PLACEHOLDER' | translate"
                      required></textarea>
                  </div>

                  <div class="form-group">
                    <label class="form-label">{{ 'SOLICITUD_CONVENIO.PASO2.OBJETIVOS' | translate }}</label>
                    <textarea
                      class="form-control"
                      [(ngModel)]="formData.objetivos"
                      name="objetivos"
                      [placeholder]="'SOLICITUD_CONVENIO.PASO2.OBJETIVOS_PLACEHOLDER' | translate"
                      required></textarea>
                  </div>
                </div>

                <!-- ============================================= -->
                <!-- PASO 3: ACCIONES -->
                <!-- ============================================= -->
                <div *ngIf="pasoActual === 2" class="form-container">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="form-title mb-0">{{ 'SOLICITUD_CONVENIO.PASO3.TITULO' | translate }}</h2>
                    <button
                      type="button"
                      class="btn-agregar-accion"
                      (click)="agregarAccion()"
                      [title]="'SOLICITUD_CONVENIO.PASO3.BTN_AGREGAR' | translate">
                      <i class="fas fa-plus-circle"></i> {{ 'SOLICITUD_CONVENIO.PASO3.BTN_AGREGAR' | translate }}
                    </button>
                  </div>

                  <div class="acciones-container">
                    <div
                      *ngFor="let accion of acciones; let i = index; trackBy: trackByIndex"
                      class="accion-card">

                      <div class="accion-header">
                        <div class="accion-numero">
                          <i class="fas fa-tasks"></i>
                          <span>{{ 'SOLICITUD_CONVENIO.PASO3.ACCION' | translate }} {{ i + 1 }}</span>
                        </div>
                        <button
                          *ngIf="acciones.length > 1"
                          type="button"
                          class="btn-eliminar-accion"
                          (click)="eliminarAccion(i)"
                          [title]="'SOLICITUD_CONVENIO.PASO3.BTN_ELIMINAR' | translate">
                          <i class="fas fa-trash-alt"></i>
                        </button>
                      </div>

                      <div class="accion-body">
                        <div class="form-group">
                          <label class="form-label">{{ 'SOLICITUD_CONVENIO.PASO3.DESCRIPCION_ACCION' | translate }}</label>
                          <textarea
                            class="form-control"
                            [(ngModel)]="accion.descripcion"
                            [name]="'descripcion_' + i"
                            [placeholder]="'SOLICITUD_CONVENIO.PASO3.DESCRIPCION_PLACEHOLDER' | translate"
                            rows="3"
                            required></textarea>
                        </div>

                        <div class="form-row">
                          <div class="form-group">
                            <label class="form-label">{{ 'SOLICITUD_CONVENIO.PASO3.FECHA_INICIO' | translate }}</label>
                            <input
                              type="date"
                              class="form-control"
                              [(ngModel)]="accion.fechaInicio"
                              [name]="'fechaInicio_' + i"
                              required>
                          </div>

                          <div class="form-group">
                            <label class="form-label">{{ 'SOLICITUD_CONVENIO.PASO3.FECHA_FIN' | translate }}</label>
                            <input
                              type="date"
                              class="form-control"
                              [(ngModel)]="accion.fechaFin"
                              [name]="'fechaFin_' + i"
                              required>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- ============================================= -->
                <!-- PASO 4: ADMINISTRADORES -->
                <!-- ============================================= -->
                <div *ngIf="pasoActual === 3" class="form-container">
                  <h2 class="form-title">{{ 'SOLICITUD_CONVENIO.PASO4.TITULO' | translate }}</h2>

                  <!-- ADMINISTRADOR INTERNO (UCM) - OBLIGATORIO -->
                  <div class="admin-section">
                    <h3 class="form-subtitle">
                      <i class="fas fa-university"></i> {{ 'SOLICITUD_CONVENIO.PASO4.ADMIN_UCM' | translate }}
                    </h3>

                    <div class="admin-card">
                      <div class="form-group">
                        <input
                          type="text"
                          class="form-control"
                          [(ngModel)]="formData.nombrecol"
                          name="nombrecol"
                          [placeholder]="'SOLICITUD_CONVENIO.PASO4.NOMBRE_ADMIN_INTERNO' | translate"
                          required>
                      </div>
                    </div>
                  </div>

                  <!-- ADMINISTRADOR EXTERNO - OPCIONAL -->
                  <div class="admin-section mt-4">
                    <h3 class="form-subtitle">
                      <i class="fas fa-building"></i> {{ 'SOLICITUD_CONVENIO.PASO4.ADMIN_EXTERNO' | translate }}
                    </h3>

                    <!-- Checkbox para activar/desactivar -->
                    <div class="form-check mb-3">
                      <input
                        type="checkbox"
                        class="form-check-input"
                        id="tieneAdminExterno"
                        [(ngModel)]="tieneAdminExterno"
                        name="tieneAdminExterno">
                      <label class="form-check-label" for="tieneAdminExterno">
                        <i class="fas fa-info-circle text-muted"></i>
                        {{ 'SOLICITUD_CONVENIO.PASO4.TIENE_ADMIN_EXTERNO' | translate }}
                      </label>
                    </div>

                    <!-- Campos del administrador externo -->
                    <div *ngIf="tieneAdminExterno" class="admin-card">
                      <div class="form-row">
                        <div class="form-group">
                          <label class="form-label">
                            {{ 'SOLICITUD_CONVENIO.PASO4.NOMBRE_COMPLETO' | translate }} <span style="color: #ef4444;">*</span>
                          </label>
                          <input
                            type="text"
                            class="form-control"
                            [(ngModel)]="administradorExterno.nombre"
                            name="adminExternoNombre"
                            [placeholder]="'SOLICITUD_CONVENIO.PASO4.NOMBRE_EXTERNO_PLACEHOLDER' | translate"
                            [required]="tieneAdminExterno">
                        </div>

                        <div class="form-group">
                          <label class="form-label">
                            {{ 'SOLICITUD_CONVENIO.PASO4.CARGO' | translate }} <span style="color: #ef4444;">*</span>
                          </label>
                          <input
                            type="text"
                            class="form-control"
                            [(ngModel)]="administradorExterno.cargo"
                            name="adminExternoCargo"
                            [placeholder]="'SOLICITUD_CONVENIO.PASO4.CARGO_PLACEHOLDER' | translate"
                            [required]="tieneAdminExterno">
                        </div>
                      </div>

                      <div class="form-group">
                        <label class="form-label">
                          {{ 'SOLICITUD_CONVENIO.PASO4.CORREO' | translate }} <span style="color: #ef4444;">*</span>
                        </label>
                        <input
                          type="email"
                          class="form-control"
                          [(ngModel)]="administradorExterno.correo"
                          name="adminExternoCorreo"
                          [placeholder]="'SOLICITUD_CONVENIO.PASO4.CORREO_PLACEHOLDER' | translate"
                          [required]="tieneAdminExterno">
                      </div>
                    </div>

                    <!-- Mensaje cuando no hay admin externo -->
                    <div *ngIf="!tieneAdminExterno" class="alert alert-info">
                      <i class="fas fa-info-circle"></i>
                      {{ 'SOLICITUD_CONVENIO.PASO4.SIN_ADMIN_EXTERNO' | translate }}
                    </div>
                  </div>
                </div>

              </form>

              <!-- Navegación -->
              <div class="form-navigation">
                <button
                  class="btn btn-secondary"
                  (click)="anteriorPaso()"
                  [disabled]="pasoActual === 0">
                  <mat-icon style="font-size: 16px; width: 16px; height: 16px;">chevron_left</mat-icon>
                  {{ 'SOLICITUD_CONVENIO.NAV.ANTERIOR' | translate }}
                </button>

                <span class="progress-text">{{ 'SOLICITUD_CONVENIO.NAV.PASO' | translate }} {{ pasoActual + 1 }} {{ 'SOLICITUD_CONVENIO.NAV.DE' | translate }} {{ pasos.length }}</span>

                <button
                  *ngIf="pasoActual < pasos.length - 1"
                  class="btn btn-primary"
                  (click)="siguientePaso()">
                  {{ 'SOLICITUD_CONVENIO.NAV.SIGUIENTE' | translate }}
                  <mat-icon style="font-size: 16px; width: 16px; height: 16px;">chevron_right</mat-icon>
                </button>

                <button
                  *ngIf="pasoActual === pasos.length - 1"
                  class="btn btn-success"
                  (click)="guardar(form)">
                  <mat-icon style="font-size: 16px; width: 16px; height: 16px;">save</mat-icon>
                  {{ 'SOLICITUD_CONVENIO.NAV.GUARDAR' | translate }}
                </button>
              </div>

            </div>
          </div>

          <!-- ============================================= -->
          <!-- CONTENIDO RENOVACIÓN -->
          <!-- ============================================= -->
          <div *ngIf="tipoSolicitud === 'Renovacion'" class="w-100" style="padding: 24px;">
            <div class="renovacion-content">

              <div class="info-banner">
                <i class="fas fa-info-circle"></i>
                <span class="info-banner-text">
                  {{ 'SOLICITUD_CONVENIO.RENOVACION.INFO' | translate }}
                </span>
              </div>

              <form #formRenovacion="ngForm" (ngSubmit)="guardarRenovacion()">
                <div class="form-container">
                  <h2 class="form-title">{{ 'SOLICITUD_CONVENIO.RENOVACION.TITULO' | translate }}</h2>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">{{ 'SOLICITUD_CONVENIO.RENOVACION.CONVENIO' | translate }}</label>
                      <select
                        class="form-control"
                        [(ngModel)]="selectedConvenio"
                        name="convenio"
                        (change)="onConvenioSeleccionado()">
                        <option value="">{{ 'SOLICITUD_CONVENIO.RENOVACION.SELECCIONE_CONVENIO' | translate }}</option>
                        <option *ngFor="let c of convenios" [ngValue]="c.id">
                          {{ c.nombre }}
                        </option>
                      </select>
                    </div>

                    <div class="form-group">
                      <label class="form-label">{{ 'SOLICITUD_CONVENIO.RENOVACION.CODIGO' | translate }}</label>
                      <input
                        type="text"
                        class="form-control"
                        [(ngModel)]="formData.codigoRenovacion"
                        name="codigoRenovacion">
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">{{ 'SOLICITUD_CONVENIO.RENOVACION.TIPO_CONVENIO' | translate }}</label>
                      <select
                        class="form-control"
                        [(ngModel)]="formData.tipoConvenio"
                        name="tipoConvenio">
                        <option *ngFor="let t of tiposConvenio" [ngValue]="t.id">{{ t.descripcion }}</option>
                      </select>
                    </div>

                    <div class="form-group">
                      <label class="form-label">{{ 'SOLICITUD_CONVENIO.RENOVACION.CLASIFICACION' | translate }}</label>
                      <select
                        class="form-control"
                        [(ngModel)]="formData.ClasConvenio"
                        name="ClasConvenio">
                        <option *ngFor="let c of clasificaciones" [ngValue]="c.id">{{ c.nombre }}</option>
                      </select>
                    </div>

                    <div class="form-group">
                      <label class="form-label">{{ 'SOLICITUD_CONVENIO.RENOVACION.TIPO_ACTIVIDAD' | translate }}</label>
                      <select
                        class="form-control"
                        [(ngModel)]="formData.tipoactividad"
                        name="tipoactividad">
                        <option *ngFor="let a of tiposActividad" [ngValue]="a.id">{{ a.nombre }}</option>
                      </select>
                    </div>

                    <div class="form-group">
                      <label class="form-label">{{ 'SOLICITUD_CONVENIO.RENOVACION.CATEGORIA_SNIES' | translate }}</label>
                      <select
                        class="form-control"
                        [(ngModel)]="selectedsnies"
                        name="CategoriaSnies">
                        <option *ngFor="let c of categoriasnies" [ngValue]="c.id">{{ c.nombre }}</option>
                      </select>
                    </div>

                    <div class="form-group">
                      <label class="form-label">{{ 'SOLICITUD_CONVENIO.RENOVACION.FECHA_INICIO' | translate }}</label>
                      <input
                        type="date"
                        class="form-control"
                        [(ngModel)]="formData.fechaInicioRenovacion"
                        name="fechaInicioRenovacion">
                    </div>

                    <div class="form-group">
                      <label class="form-label">{{ 'SOLICITUD_CONVENIO.RENOVACION.FECHA_FIN' | translate }}</label>
                      <input
                        type="date"
                        class="form-control"
                        [(ngModel)]="formData.fechaFinRenovacion"
                        name="fechaFinRenovacion">
                    </div>

                    <div class="form-group">
                      <label class="form-label">{{ 'SOLICITUD_CONVENIO.RENOVACION.DESCRIPCION' | translate }}</label>
                      <input
                        type="text"
                        class="form-control"
                        [(ngModel)]="formData.descripcionRenovacion"
                        name="descripcionRenovacion">
                    </div>
                  </div>

                  <div class="form-group">
                    <label class="form-label">{{ 'SOLICITUD_CONVENIO.RENOVACION.ANTECEDENTES' | translate }}</label>
                    <textarea
                      class="form-control"
                      [(ngModel)]="formData.antecedentesRenovacion"
                      name="antecedentesRenovacion"
                      [placeholder]="'SOLICITUD_CONVENIO.RENOVACION.ANTECEDENTES_PLACEHOLDER' | translate"></textarea>
                  </div>

                  <div style="text-align: right; margin-top: 24px;">
                    <button
                      class="btn btn-success"
                      type="button"
                      (click)="guardarRenovacion()">
                      <i *ngIf="guardandoRenovacion" class="fas fa-spinner fa-spin"></i>
                      <i *ngIf="!guardandoRenovacion" class="fas fa-check"></i>
                      {{ guardandoRenovacion ? ('SOLICITUD_CONVENIO.RENOVACION.GUARDANDO' | translate) : ('SOLICITUD_CONVENIO.RENOVACION.BTN_SOLICITAR' | translate) }}
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <!-- ============================================= -->
          <!-- CONTENIDO MIS SOLICITUDES -->
          <!-- ============================================= -->
          <div *ngIf="tipoSolicitud === 'MisSolicitudes'" class="w-100" style="height: 100%;">
            <app-listsol-convenio [embebido]="true"></app-listsol-convenio>
          </div>

        </div>
      </div>
    </main>
  </div>
</div>

<!-- Notificaciones -->
<ngx-sonner-toaster />
<!-- ConfirmDialog -->
<p-confirmDialog appendTo="body" styleClass="custom-confirm-dialog"></p-confirmDialog>
