<app-sidebar></app-sidebar>

<div class="container fuente" style="padding-top: 30px;">
  <div class="row h-100">
    <main class="col-12 d-flex flex-column">
      <div class="row g-4 flex-grow-1">
        <section class="col-12 d-flex flex-column" style="font-size: 14px;">
          <div class="card shadow-sm d-flex flex-column flex-grow-1">

            <!-- Header -->
            <div class="card-header d-flex align-items-center" style="background: #E2E6F7;">
              <button title="Atrás"
                      mat-icon-button
                      (click)="goBack()"
                      [disableRipple]="true"
                      class="me-2"
                      style="background-color: transparent; width: 40px; height: 40px; padding: 0;">
                <mat-icon style="font-size: 14px; width: 14px; height: 14px;">arrow_back</mat-icon>
              </button>

              <p class="mb-0 fw-bold" style="color: #0D133F; font-size: 14px;">
                Detalle Postulación
              </p>
            </div>

            <!-- Contenido principal -->
            <div class="card-body d-flex flex-grow-1" style="background: white; height:70vh;">

              <!-- Loading -->
              <div *ngIf="loading" class="table-overlay text-center w-100">
                <i class="fas fa-spinner fa-spin fa-3x"></i>
                <p style="font-size: 13px;">Cargando datos</p>
              </div>

              <!-- Contenido -->
              <div class="stepper-container w-100 d-flex" *ngIf="!loading">

                <!-- Sidebar con steps -->
                <div class="col-3 pe-2 border-end overflow-auto" style="max-height: 65vh;">
                  <ul class="list-group">
                    <li *ngFor="let step of steps; let i = index"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                        [class.active]="i === currentStep"
                        (click)="goToStep(i)"
                        [attr.id]="'step-item-' + i"
                        style="cursor:pointer;">

                      <!-- Texto del paso -->
                      <span>{{ i+1 }}. {{ step.nombre }}</span>

                      <!-- Indicadores -->
                      <div class="d-flex align-items-center gap-2">

                        <!-- Pasos anteriores -->
                        <ng-container *ngIf="i < currentStep">
                          <i class="fas fa-check text-success"></i>
                          <div class="estado-circle-lista" [style.background]="getColorEstado(step.id)"></div>
                        </ng-container>

                        <!-- Paso actual -->
                        <ng-container *ngIf="i === currentStep">
                          <div class="estado-circle-lista" [style.background]="getColorEstado(step.id)"></div>
                        </ng-container>

                        <!-- Pasos futuros -->
                        <ng-container *ngIf="i > currentStep">
                          <div class="estado-circle-lista" style="background:#e2e8f0;"></div>
                        </ng-container>
                      </div>
                    </li>
                  </ul>
                </div>

                <!-- Contenido del paso -->
                <div class="col-9 ps-3 d-flex flex-column">

                  <!-- Header del paso con botones superiores -->
                  <div class="d-flex justify-content-between align-items-center mb-1 mt-1" *ngIf="steps[currentStep] as step">
                    <h5 class="fw-bold m-0" style="color:#18206E;">
                      {{ step.nombre }}
                    </h5>

                    <div class="d-flex align-items-center gap-2 flex-wrap">
                      <button class="btn-notif-round"
                              (click)="onEnviarNotificacion(step)"
                              title="Enviar Notificación">
                        <i class="fas fa-paper-plane"></i>
                      </button>

                      <button class="btn-notif-round"
                              (click)="onVerNotificaciones()"
                              title="Ver Notificaciones">
                        <i class="fas fa-bell"></i>
                      </button>

                      <button class="btn-notif-round" title="Ver Histórico">
                        <i class="fas fa-history"></i>
                      </button>

                      <button class="btn-notif-round"
                              (click)="onGestioDocumental(step)"
                              title="Gestión Documental">
                        <i class="fas fa-upload"></i>
                      </button>

                      <!-- Botón Finanzas -->
                        <button class="btn-notif-round"
                                (click)="onGestioFinanciacion(step)"
                                title="Gestión de Financiación">
                          <i class="fas fa-hand-holding-usd"></i>
                        </button>

                        <!-- Botón Beneficios -->
                        <button class="btn-notif-round"
                                (click)="onGestioBeneficios(step)"
                                title="Gestión de Beneficios">
                          <i class="fas fa-gift"></i>
                        </button>

                        <!-- Botón Encuenta satisfacción -->
                        <button class="btn-notif-round"
                                (click)="onGestioEncuesta(step)"
                                title="Gestión de Beneficios">
                          <i class="fas fa-file"></i>
                        </button>

                      <div class="estado-circle" [style.background]="getColorEstado(step.id)"></div>
                    </div>
                  </div>

                  <!-- Barra de progreso -->
                  <div class="progress my-2" style="height: 6px;">
                    <div class="progress-bar" role="progressbar"
                         [style.width.%]="(currentStep+1)/steps.length*100"></div>
                  </div>

                  <form #form="ngForm" novalidate>
                    <div class="step-content flex-grow-1 p-3 border rounded bg-white overflow-auto">
                      <div class="row">
                        <div class="col-md-6 col-lg-4 mb-3"
                            *ngFor="let field of (steps[currentStep] ? campoEstado[steps[currentStep].id] : []); let j = index">

                          <label class="form-label d-block">
                            {{ field.label }}
                          </label>

                          <!-- READONLY -->
                          <p *ngIf="field.tipo === 'readonly'" class="fw-bold mb-1 text-muted">
                            {{ steps[currentStep].data[field.name] || '-' }}
                          </p>

                          <!-- TEXT -->
                          <input *ngIf="field.tipo === 'text'" type="text"
                                class="form-control form-control-sm"
                                [name]="'ctrl-'+currentStep+'-'+j"
                                [(ngModel)]="steps[currentStep].data[field.name]"
                                [readonly]="!field.editable"
                                [required]="!!field.editable">

                          <!-- NUMBER -->
                          <input *ngIf="field.tipo === 'number'" type="number"
                                class="form-control form-control-sm"
                                [name]="'ctrl-'+currentStep+'-'+j"
                                [(ngModel)]="steps[currentStep].data[field.name]"
                                [readonly]="!field.editable"
                                [required]="!!field.editable">

                          <!-- TEXTAREA -->
                          <textarea *ngIf="field.tipo === 'textarea'"
                                    class="form-control form-control-sm"
                                    [name]="'ctrl-'+currentStep+'-'+j"
                                    [(ngModel)]="steps[currentStep].data[field.name]"
                                    [readonly]="!field.editable"
                                    [required]="!!field.editable"
                                    rows="3"></textarea>

                          <!-- SELECT -->
                          <select *ngIf="field.tipo === 'select' || field.tipo === 'selectChange'"
                                  class="form-select form-select-sm"
                                  [name]="'ctrl-'+currentStep+'-'+j"
                                  [(ngModel)]="steps[currentStep].data[field.name]"
                                  (ngModelChange)="field.tipo === 'selectChange' ? onFieldChange(field, $event) : null"
                                  [disabled]="!field.editable"
                                  [required]="!!field.editable">
                            <option value="" disabled *ngIf="field.editable">Seleccione...</option>
                            <option *ngFor="let opt of field.opciones" [value]="opt.value">{{ opt.label }}</option>
                          </select>

                          <!-- DATE -->
                          <input *ngIf="field.tipo === 'date'" type="date"
                                class="form-control form-control-sm"
                                [name]="'ctrl-'+currentStep+'-'+j"
                                [(ngModel)]="steps[currentStep].data[field.name]"
                                [readonly]="!field.editable"
                                [required]="!!field.editable">

                          <!-- CHECKBOX -->
                          <div *ngIf="field.tipo === 'checkbox'" class="form-check">
                            <input type="checkbox" class="form-check-input"
                                  [name]="'ctrl-'+currentStep+'-'+j"
                                  [(ngModel)]="steps[currentStep].data[field.name]"
                                  [disabled]="!field.editable"
                                  [required]="!!field.editable">
                            <span class="form-check-label small">
                              {{ steps[currentStep].data[field.name] ? 'Sí' : 'No' }}
                            </span>
                          </div>

                          <div class="invalid-feedback d-block"
                              *ngIf="form.controls['ctrl-'+currentStep+'-'+j]?.invalid &&
                                      (form.controls['ctrl-'+currentStep+'-'+j]?.touched || form.submitted)">
                            Este campo es obligatorio.
                          </div>

                        </div>
                      </div>
                    </div>

                    <!-- Footer (botones) -->
                    <div class="d-flex justify-content-between align-items-center flex-wrap mt-2" *ngIf="steps[currentStep] as step">
                      <small class="fw-bold">Paso {{ currentStep+1 }} de {{ steps.length }}</small>

                      <div class="d-flex justify-content-between mt-3">
                        <button class="btn btn-outline-primary" (click)="prevStep()" [disabled]="currentStep === 0">Anterior</button>
                        <button class="btn btn-primary" (click)="nextStep()" [disabled]="currentStep === steps.length - 1">Siguiente</button>
                      </div>

                      <div class="d-flex align-items-center gap-2 flex-wrap step-actions" style="margin-right: 5px;">
                        <button *ngFor="let btn of accionesEstado[step.id] || []"
                                mat-raised-button
                                [color]="getButtonColor(btn.texto)"
                                class="btn-dinamico"
                                (click)="btn.accion(form)"
                                [disabled]="step.id === 1 && form && !form.form.valid"
                                style="background: #18206E; color: white;"
                                [ngClass]="{'btn-bloqueado': step.id === 1 && form && !form.form.valid}">
                          <mat-icon class="me-1" style="margin-left: 3px; color: #00ACD4;" [ngClass]="{'btn-bloqueado': step.id === 1 && form && !form.form.valid}">
                            {{ getButtonIcon(btn.texto) }}
                          </mat-icon>
                          {{ btn.texto }}
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>
</div>

<!-- Modal Notificacion -->
<div class="modal fade" id="NotificacionModal" tabindex="-1" aria-labelledby="NotificacionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="background: #E2E6F7;">
        <p class="modal-title" id="NotificacionModalLabel" style="color: #0D133F;">
          Notificaciones de la Convocatoria
        </p>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <app-notificaciones [postulacionId]="idPostulacion"></app-notificaciones>
      </div>
    </div>
  </div>
</div>

<!-- Modal Gestión Entregable -->
<div *ngIf="convocatoriaId && convocatoria && documento"
     class="modal fade"
     id="GestionDocumentalnModal"
     tabindex="-1"
     aria-labelledby="GestionDocumentalnModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header" style="background: #E2E6F7;">
        <p class="modal-title" id="GestionDocumentalnModalLabel" style="color: #0D133F;">
          Administración Documental
        </p>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <app-gestion-entregable
          [idConvocatoria]="convocatoriaId"
          [convocatoria]="convocatoria"
          [documento]="documento">
        </app-gestion-entregable>
        <!-- <app-gestion-entregable
          [idConvocatoria]="convocatoriaId"
          [convocatoria]="convocatoria"
          [documento]="documento">
        </app-gestion-entregable> -->
      </div>
    </div>
  </div>
</div>

<!-- Modal Beneficios Postulaciónn -->
<div *ngIf="convocatoriaId && convocatoria && documento" class="modal fade" id="BeneficiosModal" tabindex="-1" aria-labelledby="BeneficiosModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header" style="background: #E2E6F7;">
        <p class="modal-title" id="BeneficiosModalLabel" style="color: #0D133F;">
          Administrar Beneficios - Postulaciones
        </p>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <app-beneficios-postulacion [postulacionId]="idPostulacion" [convocatoriaId]="convocatoriaId"></app-beneficios-postulacion>
      </div>
    </div>
  </div>
</div>

<!-- Modal Beneficios Financiacion -->
<div *ngIf="convocatoriaId && convocatoria && documento" class="modal fade" id="FinanciacionModel" tabindex="-1" aria-labelledby="FinanciacionModelLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header" style="background: #E2E6F7;">
        <p class="modal-title" id="FinanciacionModelLabel" style="color: #0D133F;">
          Administrar Beneficios - Postulaciones
        </p>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <app-financiacion [postulacionId]="idPostulacion" ></app-financiacion>
      </div>
    </div>
  </div>
</div>

<!-- Notificaciones de ngx-sonner -->
<ngx-sonner-toaster />
<!-- ConfirmDialog de PrimeNG -->
<p-confirmDialog appendTo="body" styleClass="custom-confirm-dialog"></p-confirmDialog>
