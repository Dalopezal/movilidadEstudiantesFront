<app-sidebar></app-sidebar>
<div class="container fuente" style="padding-top: 30px;">
  <div class="row h-100">
    <main class="col-12 col-md-12 d-flex flex-column">
      <div class="row g-4 flex-grow-1">

        <!-- Tabla -->
        <section class="col-12 col-lg-12 d-flex flex-column" style="height: 75vh;font-size: 14px;">
          <div class="card shadow-sm d-flex flex-column flex-grow-1">
            <div class="card-header d-flex align-items-center" style="background: #E2E6F7;">
              <p class="mb-0" style="color: #0D133F;font-weight: bold;">Aprobación estudiantes</p>
            </div>

            <!-- Fila de combos -->
            <div class="card-header d-flex align-items-center gap-3" style="background: white;margin-bottom: 10px;">
              <select
                class="form-select"
                id="planeacionId"
                name="planeacionId"
                required
                style="font-size: 13px;"
                [(ngModel)]="planeacionId"
              >
                <option [ngValue]="null">Selección Planeación</option>
                <option *ngFor="let p of listaPlaneaciones" [ngValue]="p.id">{{ p.titulo }}</option>
              </select>

              <select
                class="form-select"
                id="programaId"
                name="programaId"
                required
                style="font-size: 13px;"
                [(ngModel)]="programaCodigo"
                (change)="onProgramaChange()"
              >
                <option [ngValue]="null">Programa</option>
                <option *ngFor="let prog of listaProgramas" [ngValue]="prog.codigo">
                  {{ prog.nombre }}
                </option>
              </select>

              <select
                class="form-select"
                id="componenteId"
                name="componenteId"
                required
                style="font-size: 13px;"
                [(ngModel)]="componenteCodigo"
                (change)="onComponenteChange()"
              >
                <option [ngValue]="null">Componente</option>
                <option *ngFor="let comp of listaComponentes" [ngValue]="comp.codigo">
                  {{ comp.nombre }}
                </option>
              </select>

              <select
                class="form-select"
                id="grupoId"
                name="grupoId"
                required
                style="font-size: 13px;"
                [(ngModel)]="grupoId"
              >
                <option [ngValue]="null">Grupo</option>
                <option *ngFor="let grupo of listaGrupos" [ngValue]="grupo">
                  {{ grupo }}
                </option>
              </select>

              <button
                class="btn btn-primary align-items-center gap-2"
                style="background: #0D133F; border-color: #0D133F;font-size: 13px;padding: 5px 8px;white-space: nowrap;"
                (click)="buscarEstudiantes()"
                [disabled]="loading"
              >
                <i class="fas fa-search"></i> Buscar Estudiantes
              </button>
            </div>

            <!-- Fila de búsqueda y botón refrescar -->
            <div class="card-header d-flex align-items-center gap-3" style="background: white;">
              <div class="d-flex align-items-center gap-3">
                <!-- Refrescar -->
                <button
                  class="btn btn-primary d-flex align-items-center gap-2"
                  style="background:#0D133F;border-color:#0D133F;font-size:13px;padding:5px 8px;"
                  (click)="refrescarTabla()"
                >
                  <i class="fas fa-sync-alt"></i> Limpiar
                </button>

                <!-- Búsqueda por cédula -->
                <input
                  type="text"
                  class="form-control"
                  placeholder="Digite cédula estudiante"
                  [(ngModel)]="filtroCedula"
                  name="filtroCedula"
                  style="border-radius:22px;background:#f2f0f0;font-size:13px;width:300px;"
                />
                <button
                  class="btn btn-primary d-flex align-items-center gap-2"
                  style="background:#0D133F;border-color:#0D133F;font-size:13px;padding:5px 8px;"
                  (click)="buscarPorCedula()"
                >
                  <i class="fas fa-search"></i> Buscar
                </button>
                <button
                  class="btn btn-primary"
                  style="background:#0D133F;border-color:#0D133F;font-size:13px;padding:5px 15px;"
                  (click)="guardarEstudiantes()"
                  [disabled]="!botonGuardarHabilitado || loading"
                >
                  <i class="fas fa-save"></i> Guardar Estudiantes
                </button>
              </div>
            </div>

            <!-- Tabla -->
            <div
              class="table-responsive table-wrapper flex-grow-1"
            >
              <table class="table table-striped mb-0">
                <thead class="table-primary" style="font-size: 13px">
                  <tr align="left">
                    <th style="background: white;color: #0D133F;">Cedula</th>
                    <th style="background: white;color: #0D133F;">Nombre</th>
                    <th style="background: white; color: #0D133F; vertical-align: middle;">
                      Aprobó?
                    </th>
                    <th style="background: white; color: #0D133F; vertical-align: middle; width: 180px;">
                      <div class="d-flex align-items-center justify-content-center gap-2" style="font-size: 13px;">
                        <input
                          type="checkbox"
                          class="form-check-input large-checkbox"
                          id="seleccionarTodos"
                          [(ngModel)]="seleccionarTodos"
                          (change)="toggleSeleccionarTodos()"
                          [disabled]="!botonGuardarHabilitado"
                          style="cursor: pointer;"
                        />
                        <label
                          class="form-check-label"
                          for="seleccionarTodos"
                          style="cursor: pointer; user-select: none;"
                        >
                          Seleccionar todos
                        </label>
                      </div>
                    </th>
                  </tr>
                </thead>
                <tbody style="font-size: 13px;">
                  <!-- Loader como fila válida -->
                  <tr *ngIf="loading">
                    <td colspan="4" class="text-center">
                      <i class="fas fa-spinner fa-spin fa-3x"></i>
                      <p style="background: transparent; margin: 0;">Cargando datos</p>
                    </td>
                  </tr>

                  <tr *ngFor="let item of pagedData; trackBy: trackByIndex">
                    <td align="center">{{ item.cedula }}</td>
                    <td>{{ item.nombre }}</td>
                    <td>
                      <button *ngIf="item.aprobo" class="button-completed">Si</button>
                      <button *ngIf="!item.aprobo" class="button-pending">No</button>
                    </td>
                    <td align="center">
                      <div class="form-check d-flex justify-content-center">
                        <input
                          type="checkbox"
                          class="form-check-input large-checkbox"
                          [(ngModel)]="item.aprobo"
                          [disabled]="!botonGuardarHabilitado"
                          style="cursor: pointer;"
                        />
                      </div>
                    </td>
                  </tr>

                  <tr *ngIf="!loading && pagedData.length === 0">
                    <td colspan="4" class="text-center">No hay registros.</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Paginación -->
            <div class="card-footer d-flex justify-content-between align-items-center flex-wrap">
              <div class="items-per-page d-flex align-items-center gap-2">
                <label for="itemsPerPageSelect" class="mb-0">Mostrar</label>
                <select id="itemsPerPageSelect" (change)="onPageSizeChange($event)" [value]="pageSize">
                  <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
                </select>
                <span>de {{ data.length }}</span>
              </div>

              <nav>
                <ul class="pagination mb-0">
                  <li class="page-item" [class.disabled]="currentPage === 1">
                    <button class="page-link text-white" (click)="goToPage(currentPage - 1)" style="background:#0D133F">
                      &laquo;
                    </button>
                  </li>
                  <li class="page-item" *ngFor="let page of pages" [class.active]="page === currentPage">
                    <button class="page-link" (click)="goToPage(page)">{{ page }}</button>
                  </li>
                  <li class="page-item" [class.disabled]="currentPage === totalPages">
                    <button class="page-link text-white" (click)="goToPage(currentPage + 1)" style="background:#0D133F">
                      &raquo;
                    </button>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>
</div>

<!-- Notificaciones -->
<ngx-sonner-toaster />
<!-- Confirm Dialog -->
<p-confirmDialog appendTo="body"></p-confirmDialog>
